# Инструкция по деплою на Timeweb Cloud

## Домен: наследникпобеды.рф

---

## Содержание

1. [Подготовка аккаунта Timeweb Cloud](#1-подготовка-аккаунта-timeweb-cloud)
2. [Создание базы данных PostgreSQL](#2-создание-базы-данных-postgresql)
3. [Создание S3 хранилища](#3-создание-s3-хранилища)
4. [Настройка почты для домена](#4-настройка-почты-для-домена)
5. [Деплой Backend (NestJS)](#5-деплой-backend-nestjs)
6. [Деплой Frontend (React)](#6-деплой-frontend-react)
7. [Привязка домена](#7-привязка-домена)
8. [Проверка работоспособности](#8-проверка-работоспособности)
9. [Стоимость](#9-примерная-стоимость)

---

## 1. Подготовка аккаунта Timeweb Cloud

1. Зарегистрируйтесь на https://timeweb.cloud
2. Пополните баланс (минимум ~2000 ₽ для старта)
3. Подключите GitHub-репозиторий:
   - Перейдите в **App Platform** → **Подключить репозиторий**
   - Авторизуйте GitHub → выберите репозиторий `rebekaee1/boevoebratstvo`

---

## 2. Создание базы данных PostgreSQL

1. Перейдите в **Облачные базы данных** → **Создать**
2. Выберите **PostgreSQL**
3. Параметры:
   - **Регион:** Россия / Санкт-Петербург
   - **Тариф:** Начальный (1 CPU, 2 ГБ RAM, 20 ГБ NVMe) — от 790 ₽/мес
   - **Имя базы данных:** `nasledniki`
4. Нажмите **Создать**
5. Дождитесь создания (1-2 минуты)
6. **Запишите параметры подключения:**
   - Хост (например: `rc1a-xxx.mdb.yandexcloud.net` или IP-адрес)
   - Порт: `5432`
   - Пользователь: `gen_user` (автоматически создан)
   - Пароль: (будет показан)
   - Имя БД: `nasledniki`

**Формат DATABASE_URL:**
```
postgresql://gen_user:ПАРОЛЬ@ХОСТ:5432/nasledniki?schema=public
```

---

## 3. Создание S3 хранилища

1. Перейдите в **Хранилище S3** → **Создать бакет**
2. Параметры:
   - **Имя бакета:** `nasledniki`
   - **Регион:** `ru-1`
   - **Тип доступа:** Публичный (для загрузки файлов)
3. Нажмите **Создать**
4. Перейдите в настройки бакета → **Ключи доступа**
5. Создайте ключ доступа
6. **Запишите:**
   - Access Key
   - Secret Key
   - Endpoint: `https://s3.timeweb.cloud`

### Настройка CORS для S3

В настройках бакета → **CORS** добавьте правило:

```json
{
  "CORSRules": [
    {
      "AllowedOrigins": ["https://наследникпобеды.рф"],
      "AllowedMethods": ["GET", "PUT", "POST"],
      "AllowedHeaders": ["*"],
      "MaxAgeSeconds": 3000
    }
  ]
}
```

---

## 4. Настройка почты для домена

Timeweb предоставляет почтовый сервис для доменов.

### Вариант 1: Почта Timeweb (рекомендуется)

1. Перейдите в **Домены и SSL** → выберите `наследникпобеды.рф`
2. Настройте **Почту для домена**
3. Создайте ящик: `noreply@наследникпобеды.рф`
4. **SMTP-параметры:**
   ```
   SMTP_HOST=smtp.timeweb.ru
   SMTP_PORT=465
   SMTP_USER=noreply@наследникпобеды.рф
   SMTP_PASS=пароль-от-ящика
   SMTP_FROM=Наследники Победы <noreply@наследникпобеды.рф>
   ```

### Вариант 2: Сторонний SMTP (Yandex 360, Mail.ru для бизнеса)

Если почта Timeweb не подходит, можно использовать:
- **Yandex 360:** smtp.yandex.ru:465
- **Mail.ru для бизнеса:** smtp.mail.ru:465

---

## 5. Деплой Backend (NestJS)

### Шаг 1: Создание приложения

1. Перейдите в **App Platform** → **Создать приложение**
2. Выберите **Dockerfile**
3. Укажите репозиторий: `rebekaee1/boevoebratstvo`
4. **Путь к Dockerfile:** `backend/Dockerfile`
5. **Регион:** Россия / Санкт-Петербург
6. **Конфигурация:** Минимум 1 CPU, 1 ГБ RAM (рекомендуется 2 ГБ)

### Шаг 2: Переменные окружения

В настройках приложения → **Переменные** добавьте:

| Переменная | Значение |
|-----------|----------|
| `DATABASE_URL` | `postgresql://user:pass@host:5432/nasledniki?schema=public` |
| `JWT_SECRET` | (сгенерируйте: `openssl rand -hex 32`) |
| `JWT_REFRESH_SECRET` | (сгенерируйте: `openssl rand -hex 32`) |
| `JWT_ACCESS_EXPIRATION` | `15m` |
| `JWT_REFRESH_EXPIRATION` | `7d` |
| `S3_ENDPOINT` | `https://s3.timeweb.cloud` |
| `S3_BUCKET` | `nasledniki` |
| `S3_ACCESS_KEY` | (ваш ключ из п.3) |
| `S3_SECRET_KEY` | (ваш секрет из п.3) |
| `S3_REGION` | `ru-1` |
| `SMTP_HOST` | `smtp.timeweb.ru` |
| `SMTP_PORT` | `465` |
| `SMTP_USER` | `noreply@наследникпобеды.рф` |
| `SMTP_PASS` | (пароль) |
| `SMTP_FROM` | `Наследники Победы <noreply@наследникпобеды.рф>` |
| `PORT` | `3000` |
| `FRONTEND_URL` | `https://наследникпобеды.рф` |
| `ADMIN_EMAIL` | `admin@наследникпобеды.рф` |
| `ADMIN_PASSWORD` | (ваш пароль) |

### Шаг 3: Запуск деплоя

1. Нажмите **Создать**
2. Дождитесь завершения сборки (5-10 минут)
3. Проверьте логи на вкладке **Деплой**
4. Запишите **технический домен** backend-приложения (например: `app-xxx.timeweb-apps.com`)

### Проверка:

```bash
curl https://app-xxx.timeweb-apps.com/api
# Должен вернуть: Hello World!

curl https://app-xxx.timeweb-apps.com/api/docs
# Swagger UI
```

---

## 6. Деплой Frontend (React)

### Шаг 1: Создание приложения

1. Перейдите в **App Platform** → **Создать приложение**
2. Выберите **Dockerfile**
3. Укажите репозиторий: `rebekaee1/boevoebratstvo`
4. **Путь к Dockerfile:** `frontend/Dockerfile`
5. **Регион:** Россия / Санкт-Петербург

### Шаг 2: Build Argument

В настройках → **Переменные сборки** (Build Arguments):

| Переменная | Значение |
|-----------|----------|
| `VITE_API_URL` | `https://app-xxx.timeweb-apps.com/api` |

> ⚠️ **Важно:** Замените `app-xxx.timeweb-apps.com` на реальный технический домен вашего backend-приложения (из п.5).
>
> Позже, когда привяжете домен к backend, можно будет заменить на: `https://api.наследникпобеды.рф/api`

### Шаг 3: Запуск

1. Нажмите **Создать**
2. Дождитесь завершения сборки (3-5 минут)
3. Откройте технический домен frontend — должна появиться главная страница

---

## 7. Привязка домена

### 7.1 Добавление домена в Timeweb Cloud

1. Перейдите в **Домены и SSL** → **Добавить домен**
2. Укажите: `наследникпобеды.рф`
3. Привяжите к сервису: выберите **Frontend-приложение**

### 7.2 NS-серверы

У регистратора домена (где куплен `наследникпобеды.рф`) пропишите NS-серверы Timeweb:

```
ns1.timeweb.ru
ns2.timeweb.ru
ns3.timeweb.org
ns4.timeweb.org
```

**Или:** добавьте A-запись с IP-адресом вашего frontend-приложения.

### 7.3 Субдомен для Backend API

Создайте субдомен `api.наследникпобеды.рф`:

1. В **Домены и SSL** → `наследникпобеды.рф` → **DNS**
2. Добавьте **A-запись**:
   - Поддомен: `api`
   - Привязать к сервису: **Backend-приложение**
3. Обновите CORS в backend (переменная `FRONTEND_URL`)
4. Обновите `VITE_API_URL` в frontend на `https://api.наследникпобеды.рф/api`
5. Передеплойте оба приложения

### 7.4 SSL-сертификат

SSL-сертификат Let's Encrypt **выпускается автоматически** при привязке домена. Timeweb Cloud также автоматически продлевает его.

### 7.5 Время обновления DNS

После смены NS-серверов подождите от 2 до 24 часов для распространения DNS по всему миру.

---

## 8. Проверка работоспособности

### Чек-лист после деплоя:

- [ ] Главная страница открывается по `https://наследникпобеды.рф`
- [ ] API отвечает по `https://api.наследникпобеды.рф/api`
- [ ] Swagger работает: `https://api.наследникпобеды.рф/api/docs`
- [ ] Регистрация нового участника
- [ ] Email-уведомление приходит
- [ ] Вход администратора
- [ ] Загрузка файла работы
- [ ] Скачивание файла работы
- [ ] Вход эксперта
- [ ] Оценка работы
- [ ] Экспорт в Excel

### Если что-то не работает:

1. **Проверьте логи** в App Platform → ваше приложение → **Логи приложения**
2. **Проверьте переменные окружения** — убедитесь что все заполнены
3. **Проверьте CORS** — `FRONTEND_URL` должен совпадать с URL frontend
4. **Проверьте подключение к БД** — `DATABASE_URL` должен быть корректным
5. **Обратитесь в поддержку** Timeweb — ответ в течение 15 минут

---

## 9. Примерная стоимость

| Сервис | Тариф | Стоимость |
|--------|-------|-----------|
| **Backend App** | 1 CPU, 1 ГБ RAM | ~399-699 ₽/мес |
| **Frontend App** | Статика (бесплатно*) | 0 ₽/мес |
| **PostgreSQL** | 1 CPU, 2 ГБ RAM, 20 ГБ | ~790 ₽/мес |
| **S3 Storage** | 10 ГБ | ~25 ₽/мес |
| **Домен** | .рф | ~200 ₽/год |
| **SSL** | Let's Encrypt | Бесплатно |
| **Почта** | 1 ящик | Бесплатно** |

**Итого: ~1200-1500 ₽/мес**

> \* Frontend-приложения на Timeweb App Platform бесплатны до определённого количества запросов.
>
> \** Почта для домена обычно входит в стоимость хостинга или тариф домена.

---

## Полезные ссылки

- [App Platform — документация](https://timeweb.cloud/docs/apps)
- [Деплой NestJS](https://timeweb.cloud/docs/apps/deploying-backend-applications/nest)
- [Деплой React](https://timeweb.cloud/docs/apps/deploying-frontend-apps/react)
- [Деплой из Dockerfile](https://timeweb.cloud/docs/apps/deploying-with-dockerfile)
- [Managed PostgreSQL](https://timeweb.cloud/docs/dbaas/postgresql)
- [S3 Storage](https://timeweb.cloud/docs/s3-storage)
- [Привязка домена](https://timeweb.cloud/docs/apps/upravlenie-apps-v-paneli)

---

*Документ подготовлен для проекта «Наследники Победы»*
